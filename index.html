<!DOCTYPE html>
<html lang="en" style="visibility:hidden;opacity:0">

<head>
    <meta charset="utf-8">
    <title>GridWorld</title>

    <!-- Preload and load CSS - reveal page once loaded -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="stylesheet" href="css/styles.css"
        onload="document.documentElement.style.visibility='';document.documentElement.style.opacity=''">
    <noscript>
        <link rel="stylesheet" href="css/styles.css">
    </noscript>

    <meta name="Description" content="Javascript library to generate a sphere covered in hexagons." />
    <meta name="Keywords"
        content="hexasphere, hexasphere.js, geodesic sphere, geodesic polyhedron, javascript, hexagons" />

    <!-- Webpack will inject CSS <link> and JS <script> tags automatically -->
    <link rel="icon" href="favicon.ico">
    <!-- Globe emoji as favicon for modern browsers -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üåç</text></svg>">
</head>

<body>
    <!-- Main Menu Overlay -->
    <div id="main-menu">
        <h1 class="menu-title">GridWorld</h1>
        <div class="menu-buttons">
            <button id="btn-singleplayer" class="menu-btn">Singleplayer</button>
            <button id="btn-multiplayer" class="menu-btn" disabled>Multiplayer</button>
            <button id="btn-new-game" class="menu-btn submenu-btn hidden">New Game</button>
            <button id="btn-store" class="menu-btn" disabled>Store</button>
            <button id="btn-load-game" class="menu-btn submenu-btn hidden">Load Game</button>
            <button id="btn-options" class="menu-btn">Options</button>
            <button id="btn-exit" class="menu-btn">Exit</button>
        </div>
    </div>

    <div id="stars" class="stars"></div>
    <div id="dashboard" class="hidden">
        <button id="menu-btn" class="dashboard-button menu-button">‚ò∞</button>
        <div id="population" class="dashboard-stat" title="Population">
            <span class="stat-icon">üë§</span>
            <span id="pop-value">0</span>
        </div>
        <div id="dashboard-right-elements" class="dashboard-right-elements">
            <button id="show-stats" class="dashboard-button stats-button" title="Statistics">üìä</button>
            <!-- CalendarDisplay inserts controls + year label here -->
            <button id="toggle-help" class="dashboard-toggle-help">?</button>
        </div>
    </div>
    <!-- View Mode Selector -->
    <div id="view-mode-selector" class="view-mode-selector hidden">
        <div class="custom-select-wrapper">
            <button class="custom-select-trigger" id="view-mode-trigger">
                <span id="view-mode-current">Terrain</span>
                <span class="custom-select-arrow">üîç</span>
            </button>
            <div class="custom-select-dropdown" id="view-mode-dropdown">
                <div class="custom-select-option" data-value="terrain">Terrain</div>
                <div class="custom-select-option" data-value="biome">Biome</div>
                <div class="custom-select-option" data-value="fertility">Fertility</div>
                <div class="custom-select-option" data-value="population">Population</div>
            </div>
        </div>
    </div>
    <div id="container">
    </div>
    <div id="tileInfoPanel" class="tile-info-panel hidden">
        <div class="tile-info-header">
            <strong id="tileInfoTitle">Tile Information</strong>
            <button id="closeInfoPanel" class="close-info-panel">√ó</button>
        </div>
        <div class="tile-info-content">
            <div class="info-panel-page" id="info-panel-page-1"><!-- Dynamic: Population --></div>
            <div class="info-panel-page hidden" id="info-panel-page-2"><!-- Dynamic: Buildings --></div>
            <div class="info-panel-page hidden" id="info-panel-page-3">
                <h3>üåæ Resources</h3>
                <p>Coming soon...</p>
            </div>
            <div class="info-panel-page hidden" id="info-panel-page-4">
                <h3>‚öîÔ∏è Military</h3>
                <p>Coming soon...</p>
            </div>
            <div class="info-panel-page hidden" id="info-panel-page-5">
                <h3>üí∞ Economy</h3>
                <p>Coming soon...</p>
            </div>
            <div class="info-panel-page hidden" id="info-panel-page-6">
                <h3>‚öôÔ∏è Settings</h3>
                <label><input type="checkbox" id="auto-manage-population"> Auto-manage population</label>
                <label><input type="checkbox" id="enable-trade"> Enable trade</label>
                <button id="reset-tile-btn">Reset Tile</button>
            </div>
        </div>
        <div class="info-panel-buttons">
            <button class="info-panel-btn active" id="info-btn-1">üë§</button>
            <button class="info-panel-btn" id="info-btn-2">üèõÔ∏è</button>
            <button class="info-panel-btn" id="info-btn-3">üåæ</button>
            <button class="info-panel-btn" id="info-btn-4">‚öîÔ∏è</button>
            <button class="info-panel-btn" id="info-btn-5">üí∞</button>
            <button class="info-panel-btn" id="info-btn-6">‚öôÔ∏è</button>
        </div>
    </div>
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Custom View Mode Selector (Opens Upward Only)
        (function() {
            let currentValue = 'terrain';

            function initializeViewModeSelector() {
                const wrapper = document.querySelector('.custom-select-wrapper');
                const trigger = document.getElementById('view-mode-trigger');
                const dropdown = document.getElementById('view-mode-dropdown');
                const currentText = document.getElementById('view-mode-current');
                const options = document.querySelectorAll('.custom-select-option');

                if (!wrapper || !trigger || !dropdown || !currentText) {
                    console.warn('View mode selector elements not found');
                    return;
                }

                console.log('View mode selector initialized');

                // Toggle dropdown
                trigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Trigger clicked, toggling dropdown');
                    wrapper.classList.toggle('open');
                });

                // Also handle mousedown for better responsiveness
                trigger.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });

                // Select option
                options.forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const value = this.getAttribute('data-value');
                        const text = this.textContent;

                        console.log('Option selected:', value);

                        // Update current selection
                        currentValue = value;
                        currentText.textContent = text;

                        // Update selected state
                        options.forEach(function(opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Close dropdown
                        wrapper.classList.remove('open');

                        // Dispatch custom event for other code to listen to
                        const event = new CustomEvent('viewModeChange', {
                            detail: { value: value, text: text }
                        });
                        document.dispatchEvent(event);
                    });
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!wrapper.contains(e.target)) {
                        wrapper.classList.remove('open');
                    }
                });

                // Set initial selected state
                const initialOption = dropdown.querySelector('[data-value="terrain"]');
                if (initialOption) {
                    initialOption.classList.add('selected');
                }

                // Make globally accessible for debugging
                window.viewModeSelector = {
                    wrapper: wrapper,
                    trigger: trigger,
                    currentValue: function() { return currentValue; },
                    toggle: function() { wrapper.classList.toggle('open'); }
                };
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeViewModeSelector);
            } else {
                // DOM already loaded
                initializeViewModeSelector();
            }
        })();
    </script>
    <script>
        // Info panel tab/page switching logic
        (function () {
            const PAGES = 6;
            const CLOSE_DEBOUNCE = 300;

            function switchPage(pageNum) {
                // Debounce close action
                if (window.__tileSelectorJustClosed && Date.now() - window.__tileSelectorJustClosed < CLOSE_DEBOUNCE) return;

                const panel = document.getElementById('tileInfoPanel');
                if (!panel) return;

                // Show panel
                panel.classList.remove('hidden');
                panel.style.cssText = 'opacity:1;transform:translateY(0);pointer-events:auto;display:flex;';

                // Switch pages using CSS classes
                for (let i = 1; i <= PAGES; i++) {
                    const page = document.getElementById('info-panel-page-' + i);
                    const btn = document.getElementById('info-btn-' + i);
                    if (page) page.classList.toggle('hidden', i !== pageNum);
                    if (btn) btn.classList.toggle('active', i === pageNum);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                for (let i = 1; i <= PAGES; i++) {
                    const btn = document.getElementById('info-btn-' + i);
                    if (btn) btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        switchPage(i);
                    });
                }

            });
        })();
    </script>
    <!-- Menu Modal -->
    <div id="menu-modal-overlay" class="menu-modal-overlay hidden">
        <div class="menu-modal">
            <div class="menu-modal-header">
                <strong>Menu</strong>
                <button class="menu-modal-close">&times;</button>
            </div>
            <div class="menu-modal-content">
                <button id="reset-data" class="menu-item reset-button">üîÑ Restart</button>
                <button id="save-game" class="menu-item save-button">üíæ Save</button>
                <button id="load-game" class="menu-item load-button">üì• Load</button>
                <button id="back-to-menu" class="menu-item back-menu-button">üè† Back to Menu</button>
            </div>
        </div>
    </div>
    <!-- Help Modal -->
    <div id="help-modal-overlay" class="menu-modal-overlay hidden">
        <div class="menu-modal" style="width: 320px;">
            <div class="menu-modal-header">
                <strong>Controls</strong>
                <button class="help-modal-close menu-modal-close">&times;</button>
            </div>
            <div class="help-modal-content">
                <div class="help-section">
                    <h4>Camera</h4>
                    <div class="help-row"><kbd>W</kbd> <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd> / Arrow keys <span>Rotate globe</span></div>
                    <div class="help-row"><kbd>+</kbd> / <kbd>-</kbd> <span>Zoom in / out</span></div>
                    <div class="help-row"><kbd>C</kbd> <span>Reset camera</span></div>
                    <div class="help-row">Scroll wheel <span>Zoom</span></div>
                    <div class="help-row">Click + drag <span>Rotate</span></div>
                </div>
                <div class="help-section">
                    <h4>Interaction</h4>
                    <div class="help-row">Click tile <span>Select &amp; inspect</span></div>
                    <div class="help-row"><kbd>F</kbd> <span>Search tile by ID</span></div>
                    <div class="help-row"><kbd>Esc</kbd> <span>Toggle menu</span></div>
                </div>
                <div class="help-section">
                    <h4>Time</h4>
                    <div class="help-row">Moon button <span>Cycle: Stop / Daily / Monthly</span></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Options Modal -->
    <div id="options-modal-overlay" class="menu-modal-overlay hidden">
        <div class="menu-modal" style="width: 33.33vw; height: 100vh; max-height: 100vh; margin: 0;">
            <div class="menu-modal-header">
                <strong>Options</strong>
                <button class="options-modal-close">&times;</button>
            </div>
            <div class="options-modal-content">
                <div class="options-section">
                    <label class="option-item">
                        <input type="checkbox" id="option-animate-stars">
                        <span>Animate background with stars</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox" id="option-show-memory">
                        <span>See memory consumption</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <!-- Tile Search Modal (toggled with F key) -->
    <div id="tile-search-modal" class="tile-search-modal hidden">
        <div class="tile-search-modal-content">
            <input type="text" id="tile-search-input" class="tile-search-input" placeholder="Tile ID" inputmode="numeric" autocomplete="off">
            <button id="tile-search-btn" class="tile-search-go">Go</button>
        </div>
    </div>
    <!-- Population updates handled via Socket.IO events in UIManager -->
    <!-- ref:include analytics -->
    <!-- endref -->

</body>

</html>